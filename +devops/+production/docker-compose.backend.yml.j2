services:
  {{ project_name }}-backend-{{ project_stage }}:
    image: ${{ project_name | upper }}_BACKEND_REGISTRY_URL:${{ project_name | upper }}_BACKEND_VERSION
    container_name: {{ project_name }}-backend-{{ project_stage }}
    restart: unless-stopped
    depends_on:
      {{ project_name }}-db-{{ project_stage }}:
        condition: service_healthy
    environment:
      - TZ=America/Lima
    env_file:
      - .env.backend
      - .env.database
    networks:
      - traefik3_proxy
      - {{ project_name }}-network-{{ project_stage}}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.{{ project_name }}-backend-{{ project_stage}}.rule=Host(`api.hotellaalmohadadelrey.com`)"
      - "traefik.http.routers.{{ project_name }}-backend-{{ project_stage}}.entrypoints=websecure"
      - "traefik.http.routers.{{ project_name }}-backend-{{ project_stage}}.tls=true"
      - "traefik.http.routers.{{ project_name }}-backend-{{ project_stage}}.tls.certresolver=dns-cloudflare"
      - "traefik.http.routers.{{ project_name }}-backend-{{ project_stage}}.tls.domains[0].main=hotellaalmohadadelrey.com"
      - "traefik.http.routers.{{ project_name }}-backend-{{ project_stage}}.tls.domains[0].sans=*.hotellaalmohadadelrey.com"
      - "traefik.http.services.{{ project_name }}-backend-{{ project_stage}}.loadbalancer.server.port=4000"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 2
      start_period: 50s

  {{ project_name }}-borgmatic-{{ project_stage }}:
    image: ghcr.io/borgmatic-collective/borgmatic
    container_name: {{ project_name }}-borgmatic-{{ project_stage }}
    restart: unless-stopped
    depends_on:
      {{ project_name }}-db-{{ project_stage }}:
        condition: service_healthy
    volumes:
      - ./borg/repository:/mnt/borg-repository
      - ./borg/borgmatic.d:/etc/borgmatic.d/
      - ./borg/.config/borg:/root/.config/borg
      - ./borg/.ssh:/root/.ssh
      - ./borg/.cache/borg:/root/.cache/borg
      - ./borg/.state/borgmatic:/root/.local/state/borgmatic
      - ~/.ssh/hetzner:/root/.ssh/hetzner
      - ~/.ssh/hetzner.pub:/root/.ssh/hetzner.pub
    env_file:
      - ./.env.database
    environment:
      - TZ=America/Lima
      - PG_DB=$${POSTGRES_DB}
      - PG_HOST={{ project_name }}-db-{{ project_stage }}
      - PG_USER=$${POSTGRES_USER}
      - PG_PASSWORD=$${POSTGRES_PASSWORD}
      - BORG_PASSPHRASE=${BORG_PASSPHRASE}
      - RUN_ON_STARTUP=true
    networks:
      - {{ project_name }}-network-{{ project_stage}}

